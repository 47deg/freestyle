<html><head><title>Freestyle</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="47 Degrees" /><meta name="description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Freestyle" /><meta name="og:site_name" content="Freestyle" /><meta name="og:url" content="https://frees-io.github.io/freestyle-docs/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Freestyle" /><meta name="twitter:image" content="https://frees-io.github.io/freestyle-docs/img/poster.png" /><meta name="twitter:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="twitter:card" content="summary_large_image" /><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-18433785-14' , 'auto');
ga('send', 'pageview');
      </script><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/dracula.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/kazari-style.css" /><link rel="stylesheet" href="/css/monokai.css" /><link rel="stylesheet" href="/css/custom.css" /><link rel="stylesheet" href="/css/dracula.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Freestyle</span></div></a></li> <li><a href="/docs/" class="">Quick Start</a></li> <li><a href="/docs/core/" class="">Core Concepts</a> <ul class="sub_section"> <li><a href="/docs/core/algebras/" class="">Algebras</a></li> <li><a href="/docs/core/modules/" class="">Modules</a></li> <li><a href="/docs/core/interpreters/" class="">Handlers</a></li> <li><a href="/docs/core/parallelism/" class="">Parallelism</a></li> <li><a href="/docs/core/tagless/" class="">Tagless Final</a></li></ul></li> <li><a href="/docs/effects/" class="">Effects</a> <ul class="sub_section"> <li><a href="/docs/effects/error" class="">Error</a></li> <li><a href="/docs/effects/either" class="">Either</a></li> <li><a href="/docs/effects/option" class="">Option</a></li> <li><a href="/docs/effects/reader" class="">Reader</a></li> <li><a href="/docs/effects/writer" class="">Writer</a></li> <li><a href="/docs/effects/state" class="">State</a></li> <li><a href="/docs/effects/traverse" class="">Traverse</a></li> <li><a href="/docs/effects/validation" class="">Validation</a></li> <li><a href="/docs/effects/async" class="">Async Callbacks</a></li></ul></li> <li><a href="/docs/optimizations/" class="">Optimizations</a></li> <li><a href="/docs/stack/" class="">Example Target Stack</a></li> <li><a href="/TODO.html" class="">Patterns</a> <ul class="sub_section"> <li><a href="/docs/effects/Cache/" class="">Cache</a></li> <li><a href="/TODO.html" class="">Dependency Injection</a></li> <li><a href="/docs/patterns/config" class="">Configuration</a></li> <li><a href="/docs/patterns/logging" class="">Logging</a></li></ul></li> <li><a href="/docs/integrations" class="">Integrations</a> <ul class="sub_section"> <li><a href="/docs/integrations/cats" class="">Cats</a></li> <li><a href="/docs/integrations/play" class="">Play Framework</a></li> <li><a href="/docs/integrations/monix" class="">Monix</a></li> <li><a href="/docs/integrations/fetch" class="">Fetch</a></li> <li><a href="/docs/integrations/fs2" class="">FS2</a></li> <li><a href="/docs/integrations/doobie" class="">Doobie</a></li> <li><a href="/docs/integrations/slick" class="">Slick</a></li> <li><a href="/docs/integrations/akkahttp" class="">Akka HTTP</a></li> <li><a href="/docs/integrations/finch" class="">Finch</a></li> <li><a href="/docs/integrations/http4s" class="">http4s</a></li></ul></li> <li><a href="/docs/related/" class="">Related Work</a> <ul class="sub_section"> <li><a href="/docs/related/#bibliography" class="">Bibliography</a></li> <li><a href="/docs/related/#Scala" class="">Scala Libraries</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="frees-io" data-github-repo="freestyle"><div class="content-wrapper"><section><p>In the following example, we will see how a module with two algebras can be used in combination with some of the effect algebras provided by Freestyle.</p>

<p>In this example, a company selling multiple varieties of apples wants to process its customers’ orders. The orders need to be validated, the stock levels of apples checked to make sure the order can be fulfilled, and finally, the order needs to be processed.</p>

<p>We start by importing Freestyle’s core:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">freestyle._</span>
<span class="k">import</span> <span class="nn">freestyle.implicits._</span>
</code></pre>
</div>

<p>Now we can create data types for a customer and an order together with a <code class="highlighter-rouge">Config</code> data type which holds a set of all the apple varieties the company sells.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">type</span> <span class="kt">CustomerId</span> <span class="o">=</span> <span class="nc">UUID</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Customer</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">CustomerId</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Order</span><span class="o">(</span><span class="n">crates</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">variety</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">customerId</span><span class="k">:</span> <span class="kt">CustomerId</span><span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Config</span><span class="o">(</span><span class="n">varieties</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
</code></pre>
</div>

<p>It should be possible to get a <code class="highlighter-rouge">Customer</code> for a specified <code class="highlighter-rouge">CustomerId</code> from a data store holding the company’s customers. We should be able to check how many crates of a specific apple variety the company has in stock, and finally, process the order.</p>

<p>We will represent these capabilities using two algebras: <code class="highlighter-rouge">CustomerPersistence</code> and <code class="highlighter-rouge">StockPersistence</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">object</span> <span class="nc">algebras</span> <span class="o">{</span>
  <span class="nd">@free</span> <span class="k">trait</span> <span class="nc">CustomerPersistence</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">getCustomer</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">CustomerId</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Customer</span><span class="o">]]</span>
  <span class="o">}</span>

  <span class="nd">@free</span> <span class="k">trait</span> <span class="nc">StockPersistence</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">checkQuantityAvailable</span><span class="o">(</span><span class="n">variety</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
    <span class="k">def</span> <span class="n">registerOrder</span><span class="o">(</span><span class="n">order</span><span class="k">:</span> <span class="kt">Order</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// defined object algebras
</span></code></pre>
</div>

<p>These two algebras will be combined together in a <code class="highlighter-rouge">Persistence</code> module, that in turn will be part of our <code class="highlighter-rouge">App</code> module, that additionally includes the
capabilities to fail, to read from our <code class="highlighter-rouge">Config</code> configuration, and to cache <code class="highlighter-rouge">Customer</code>s using respectively <code class="highlighter-rouge">error</code> and <code class="highlighter-rouge">reader</code> from the <em>freestyle-effects</em> module and <code class="highlighter-rouge">cache</code> from the <em>freestyle-cache</em> module.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">freestyle.effects.error._</span>
<span class="c1">// import freestyle.effects.error._
</span>
<span class="k">import</span> <span class="nn">freestyle.effects.reader</span>
<span class="c1">// import freestyle.effects.reader
</span>
<span class="k">import</span> <span class="nn">freestyle.cache.KeyValueProvider</span>
<span class="c1">// import freestyle.cache.KeyValueProvider
</span>
<span class="k">object</span> <span class="nc">modules</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">rd</span> <span class="k">=</span> <span class="n">reader</span><span class="o">[</span><span class="kt">Config</span><span class="o">]</span>
  <span class="k">val</span> <span class="n">cacheP</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">KeyValueProvider</span><span class="o">[</span><span class="kt">CustomerId</span>, <span class="kt">Customer</span><span class="o">]</span>

  <span class="nd">@module</span> <span class="k">trait</span> <span class="nc">Persistence</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">customer</span><span class="k">:</span> <span class="kt">algebras.CustomerPersistence</span>
    <span class="k">val</span> <span class="n">stock</span><span class="k">:</span> <span class="kt">algebras.StockPersistence</span>
  <span class="o">}</span>

  <span class="nd">@module</span> <span class="k">trait</span> <span class="nc">App</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">persistence</span><span class="k">:</span> <span class="kt">Persistence</span>

    <span class="k">val</span> <span class="n">errorM</span><span class="k">:</span> <span class="kt">ErrorM</span>
    <span class="k">val</span> <span class="n">cacheM</span><span class="k">:</span> <span class="kt">cacheP.CacheM</span>
    <span class="k">val</span> <span class="n">readerM</span><span class="k">:</span> <span class="kt">rd.ReaderM</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// defined object modules
</span></code></pre>
</div>

<p>To validate the order, we check to make sure the number of crates ordered is larger than zero, and that the requested variety of apple is sold by the company.</p>

<p>For the second part, we use the <a href="../effects/reader"><code class="highlighter-rouge">reader</code></a> effect algebra to read the set of apple varieties from our <code class="highlighter-rouge">Config</code>.</p>

<p>We are using <a href="http://typelevel.org/cats/api/cats/data/Validated.html"><code class="highlighter-rouge">Validated</code></a> here to combine multiple errors in a <a href="http://typelevel.org/cats/api/cats/data/NonEmptyList.html"><code class="highlighter-rouge">NonEmptyList</code></a> represented by the type alias <code class="highlighter-rouge">cats.data.ValidatedNel</code>. <code class="highlighter-rouge">Validated</code> provides an easy way to accumate errors. More information can be found on the <a href="http://typelevel.org/cats/datatypes/validated.html"><code class="highlighter-rouge">Cats</code> website</a>. <code class="highlighter-rouge">NonEmptyList</code> is a <code class="highlighter-rouge">List</code> with at least one element.</p>

<p>The <code class="highlighter-rouge">|+|</code> syntax used below is provided by Cats (because <code class="highlighter-rouge">Validated</code> has a <a href="http://typelevel.org/cats/typeclasses/semigroup.html"><code class="highlighter-rouge">Semigroup</code></a> instance) which makes it possible to combine the error messages of the two checks:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">modules._</span>
<span class="c1">// import modules._
</span>
<span class="k">import</span> <span class="nn">cats.data.</span><span class="o">{</span><span class="nc">NonEmptyList</span><span class="o">,</span> <span class="nc">ValidatedNel</span><span class="o">}</span>
<span class="c1">// import cats.data.{NonEmptyList, ValidatedNel}
</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="c1">// import cats.implicits._
</span>
<span class="k">def</span> <span class="n">validateOrder</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">order</span><span class="k">:</span> <span class="kt">Order</span><span class="o">,</span> <span class="n">customer</span><span class="k">:</span> <span class="kt">Customer</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">app</span><span class="k">:</span> <span class="kt">App</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">FreeS.Par</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">ValidatedNel</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Unit</span><span class="o">]]</span> <span class="k">=</span>
  <span class="n">app</span><span class="o">.</span><span class="n">readerM</span><span class="o">.</span><span class="n">reader</span> <span class="o">{</span> <span class="n">config</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">v</span> <span class="k">=</span> <span class="o">().</span><span class="n">validNel</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
    <span class="n">v</span><span class="o">.</span><span class="n">ensure</span><span class="o">(</span><span class="nc">NonEmptyList</span><span class="o">.</span><span class="n">of</span><span class="o">(</span>
      <span class="s">"Number of crates ordered should be bigger than zero"</span><span class="o">))(</span>
      <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">order</span><span class="o">.</span><span class="n">crates</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">|+|</span>
    <span class="n">v</span><span class="o">.</span><span class="n">ensure</span><span class="o">(</span><span class="nc">NonEmptyList</span><span class="o">.</span><span class="n">of</span><span class="o">(</span>
      <span class="s">"Apple variety is not available"</span><span class="o">))(</span>
      <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">varieties</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="n">variety</span><span class="o">.</span><span class="n">toLowerCase</span><span class="o">))</span>
  <span class="o">}</span>
<span class="c1">// validateOrder: [F[_]](order: Order, customer: Customer)(implicit app: modules.App[F])freestyle.FreeS.Par[F,cats.data.ValidatedNel[String,Unit]]
</span></code></pre>
</div>

<p>When validating an order, we need to acquire the customer’s information. If a customer places multiple orders, we don’t want to send a database request every time, so we can use the <a href="../effects/Cache"><code class="highlighter-rouge">freestyle-cache</code></a> module to cache customers.</p>

<p>In the <code class="highlighter-rouge">getCustomer</code> function, we first try to locate the customer in the cache by using the cache effect algebra, if we cannot find them, we fall back to retrieving the customer from a database (or other persistence store).</p>

<p>We are using the <a href="http://typelevel.org/cats/datatypes/optiont.html"><code class="highlighter-rouge">OptionT</code></a> monad transformer here. With Freestyle, you generally don’t have to deal with monad transformers in your actual domain code. They are only used in the handlers and when executing your program on the edge. In this case though, Freestyle and the <code class="highlighter-rouge">OptionT</code> monad transformer work flawlessly together. <code class="highlighter-rouge">OptionT</code> is used as a convenient wrapper over a <code class="highlighter-rouge">FreeS[F, Option[A]]</code> value and the <code class="highlighter-rouge">OptionT#orElseF</code> method makes it is easy to specify what needs to happen if the inner <code class="highlighter-rouge">Option</code> is <code class="highlighter-rouge">None</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.OptionT</span>
<span class="c1">// import cats.data.OptionT
</span>
<span class="k">def</span> <span class="n">getCustomer</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">id</span><span class="k">:</span> <span class="kt">CustomerId</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">app</span><span class="k">:</span> <span class="kt">App</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Option</span><span class="o">[</span><span class="kt">Customer</span><span class="o">]]</span> <span class="k">=</span>
  <span class="c1">// first try to get the customer from the cache
</span>  <span class="nc">OptionT</span><span class="o">(</span><span class="n">app</span><span class="o">.</span><span class="n">cacheM</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="n">freeS</span><span class="o">).</span><span class="n">orElseF</span> <span class="o">{</span>
    <span class="c1">// otherwise fallback and get the customer from a persistent store http://typelevel.org/cats/datatypes/optiont.html
</span>    <span class="k">for</span> <span class="o">{</span>
      <span class="n">customer</span> <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">customer</span><span class="o">.</span><span class="n">getCustomer</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="n">freeS</span>
      <span class="k">_</span>        <span class="k">&lt;-</span> <span class="n">customer</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span>
                    <span class="o">().</span><span class="n">pure</span><span class="o">[</span><span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">?</span><span class="o">]])(</span>
                    <span class="c1">// put customer in cache
</span>                    <span class="n">cust</span> <span class="k">=&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">cacheM</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">cust</span><span class="o">))</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">customer</span>
  <span class="o">}.</span><span class="n">value</span>
<span class="c1">// getCustomer: [F[_]](id: CustomerId)(implicit app: modules.App[F])freestyle.FreeS[F,Option[Customer]]
</span></code></pre>
</div>

<p>Next we will create a couple of domain specific exception case classes:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">AppleException</span><span class="o">(</span><span class="k">val</span> <span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Exception</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">CustomerNotFound</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">CustomerId</span><span class="o">)</span>               <span class="k">extends</span> <span class="nc">AppleException</span><span class="o">(</span><span class="n">s</span><span class="s">"Customer $id can not be found"</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">QuantityNotAvailable</span><span class="o">(</span><span class="n">error</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>            <span class="k">extends</span> <span class="nc">AppleException</span><span class="o">(</span><span class="n">error</span><span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">ValidationFailed</span><span class="o">(</span><span class="n">errors</span><span class="k">:</span> <span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AppleException</span><span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="n">intercalate</span><span class="o">(</span><span class="s">"\n"</span><span class="o">))</span>
</code></pre>
</div>

<p>We can use the <code class="highlighter-rouge">validateOrder</code> and <code class="highlighter-rouge">getCustomer</code> methods in combination with our persistence algebras and the <code class="highlighter-rouge">error</code> effect algebra, to create the <code class="highlighter-rouge">processOrder</code> method tying everything together:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="n">processOrder</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">order</span><span class="k">:</span> <span class="kt">Order</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">app</span><span class="k">:</span> <span class="kt">App</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">app.persistence._</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="n">errorM</span><span class="o">.</span><span class="k">_</span>
  <span class="k">for</span> <span class="o">{</span>
    <span class="n">customerOpt</span> <span class="k">&lt;-</span> <span class="n">getCustomer</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">order</span><span class="o">.</span><span class="n">customerId</span><span class="o">)</span>
    <span class="n">customer</span>    <span class="k">&lt;-</span> <span class="n">either</span><span class="o">(</span><span class="n">customerOpt</span><span class="o">.</span><span class="n">toRight</span><span class="o">(</span><span class="nc">CustomerNotFound</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="n">customerId</span><span class="o">)))</span>
    <span class="n">validation</span>  <span class="k">&lt;-</span> <span class="n">validateOrder</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">order</span><span class="o">,</span> <span class="n">customer</span><span class="o">)</span>
    <span class="k">_</span>           <span class="k">&lt;-</span> <span class="n">either</span><span class="o">(</span><span class="n">validation</span><span class="o">.</span><span class="n">toEither</span><span class="o">.</span><span class="n">leftMap</span><span class="o">(</span><span class="nc">ValidationFailed</span><span class="o">))</span>
    <span class="n">nbAvailable</span> <span class="k">&lt;-</span> <span class="n">stock</span><span class="o">.</span><span class="n">checkQuantityAvailable</span><span class="o">(</span><span class="n">order</span><span class="o">.</span><span class="n">variety</span><span class="o">)</span>
    <span class="k">_</span>           <span class="k">&lt;-</span> <span class="n">either</span><span class="o">(</span>
                     <span class="nc">Either</span><span class="o">.</span><span class="n">cond</span><span class="o">(</span>
                       <span class="n">order</span><span class="o">.</span><span class="n">crates</span> <span class="o">&lt;=</span> <span class="n">nbAvailable</span><span class="o">,</span>
                       <span class="o">(),</span>
                       <span class="nc">QuantityNotAvailable</span><span class="o">(</span>
                         <span class="n">s</span><span class="s">"""There are insufficient crates of ${order.variety} apples in stock
                            |(only $nbAvailable available, while ${order.crates} needed - $order)."""</span><span class="o">.</span><span class="n">stripMargin</span><span class="o">)</span>
                     <span class="o">)</span>
                   <span class="o">)</span>
    <span class="k">_</span>          <span class="k">&lt;-</span> <span class="n">stock</span><span class="o">.</span><span class="n">registerOrder</span><span class="o">(</span><span class="n">order</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">s</span><span class="s">"Order registered for customer ${order.customerId}"</span>
<span class="o">}</span>
<span class="c1">// processOrder: [F[_]](order: Order)(implicit app: modules.App[F])freestyle.FreeS[F,String]
</span></code></pre>
</div>

<p>As a target type of our computation, we choose a combination of <code class="highlighter-rouge">Kleisli</code> and <code class="highlighter-rouge">fs2.Task</code>.</p>

<ul>
  <li><a href="http://typelevel.org/cats/datatypes/kleisli.html"><code class="highlighter-rouge">Kleisli</code></a> or <code class="highlighter-rouge">ReaderT</code> is like an <code class="highlighter-rouge">A =&gt; F[B]</code> function, where <code class="highlighter-rouge">A</code> can be seen as an <a href="http://typelevel.org/cats/datatypes/kleisli.html#configuration">environment or configuration</a> type. In this case, <code class="highlighter-rouge">Stack</code> can be seen as <code class="highlighter-rouge">Config =&gt; Task[A]</code>,</li>
  <li><a href="https://oss.sonatype.org/service/local/repositories/releases/archive/co/fs2/fs2-core_2.12/0.9.4/fs2-core_2.12-0.9.4-javadoc.jar/!/fs2/Task.html"><code class="highlighter-rouge">fs2.Task</code></a> is a data type that can be used for potentially lazy computations which can contain asynchronous steps. The <code class="highlighter-rouge">Task</code> implementation used in this case is from the <a href="https://github.com/functional-streams-for-scala/fs2">FS2 library</a>, similar data types can be found in <a href="https://github.com/monix/monix">Monix</a> (<a href="https://monix.io/docs/2x/eval/task.html"><code class="highlighter-rouge">Monix.eval.Task</code></a>) and <a href="https://github.com/scalaz/scalaz">Scalaz</a> (<a href="http://timperrett.com/2014/07/20/scalaz-task-the-missing-documentation/"><code class="highlighter-rouge">scalaz.concurrent.Task</code></a>).</li>
</ul>

<p>We use <code class="highlighter-rouge">Kleisli</code> to fulfil the <code class="highlighter-rouge">ReaderM</code> constraint and <code class="highlighter-rouge">Task</code> the <code class="highlighter-rouge">ErrorM</code> constraint:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Kleisli</span>
<span class="c1">// import cats.data.Kleisli
</span>
<span class="k">import</span> <span class="nn">_root_.fs2.Task</span>
<span class="c1">// import _root_.fs2.Task
</span>
<span class="k">import</span> <span class="nn">_root_.fs2.interop.cats._</span>
<span class="c1">// import _root_.fs2.interop.cats._
</span>
<span class="k">type</span> <span class="kt">Stack</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Kleisli</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Config</span>, <span class="kt">A</span><span class="o">]</span>
<span class="c1">// defined type alias Stack
</span></code></pre>
</div>

<p>Now we create the interpreters or handlers for algebras of our <code class="highlighter-rouge">Persistence</code> module by implementing their specific <code class="highlighter-rouge">Handler</code> traits as <code class="highlighter-rouge">x.Handler[Stack]</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">algebras._</span>
<span class="c1">// import algebras._
</span>
<span class="k">val</span> <span class="n">customerId1</span> <span class="k">=</span> <span class="nc">UUID</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="s">"00000000-0000-0000-0000-000000000000"</span><span class="o">)</span>
<span class="c1">// customerId1: java.util.UUID = 00000000-0000-0000-0000-000000000000
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">customerPersistencteHandler</span><span class="k">:</span> <span class="kt">CustomerPersistence.Handler</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">CustomerPersistence</span><span class="o">.</span><span class="nc">Handler</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">customers</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">CustomerId</span>, <span class="kt">Customer</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">Map</span><span class="o">(</span><span class="n">customerId1</span> <span class="o">-&gt;</span> <span class="nc">Customer</span><span class="o">(</span><span class="n">customerId1</span><span class="o">,</span> <span class="s">"Apple Juice Ltd"</span><span class="o">))</span>
    <span class="k">def</span> <span class="n">getCustomer</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">CustomerId</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stack</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Customer</span><span class="o">]]</span> <span class="k">=</span>
      <span class="nc">Kleisli</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Task</span><span class="o">.</span><span class="n">now</span><span class="o">(</span><span class="n">customers</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">id</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="c1">// customerPersistencteHandler: algebras.CustomerPersistence.Handler[Stack] = $anon$1@651f021f
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">stockPersistencteHandler</span><span class="k">:</span> <span class="kt">StockPersistence.Handler</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span> <span class="k">=</span>
  <span class="k">new</span> <span class="nc">StockPersistence</span><span class="o">.</span><span class="nc">Handler</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">checkQuantityAvailable</span><span class="o">(</span><span class="n">variety</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stack</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">Kleisli</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span>
        <span class="nc">Task</span><span class="o">.</span><span class="n">now</span><span class="o">(</span><span class="n">variety</span><span class="o">.</span><span class="n">toLowerCase</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="s">"granny smith"</span> <span class="k">=&gt;</span> <span class="mi">150</span>
          <span class="k">case</span> <span class="s">"jonagold"</span>     <span class="k">=&gt;</span> <span class="mi">200</span>
          <span class="k">case</span> <span class="k">_</span>              <span class="k">=&gt;</span> <span class="mi">25</span>
        <span class="o">})</span>
      <span class="o">)</span>

    <span class="k">def</span> <span class="n">registerOrder</span><span class="o">(</span><span class="n">order</span><span class="k">:</span> <span class="kt">Order</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stack</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nc">Kleisli</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Register $order"</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="c1">// stockPersistencteHandler: algebras.StockPersistence.Handler[Stack] = $anon$1@48e06c82
</span></code></pre>
</div>

<p>A handler that can cache <code class="highlighter-rouge">Customer</code>s can be created with a <code class="highlighter-rouge">ConcurrentHashMapWrapper</code> and a natural transformation to our <code class="highlighter-rouge">Stack</code> type:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.</span><span class="o">{~&gt;,</span> <span class="nc">Id</span><span class="o">}</span>
<span class="c1">// import cats.{$tilde$greater, Id}
</span>
<span class="k">import</span> <span class="nn">freestyle.cache.hashmap._</span>
<span class="c1">// import freestyle.cache.hashmap._
</span>
<span class="k">import</span> <span class="nn">freestyle.cache.KeyValueMap</span>
<span class="c1">// import freestyle.cache.KeyValueMap
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">freestyleHasherCustomerId</span><span class="k">:</span> <span class="kt">Hasher</span><span class="o">[</span><span class="kt">CustomerId</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Hasher</span><span class="o">[</span><span class="kt">CustomerId</span><span class="o">](</span><span class="k">_</span><span class="o">.</span><span class="n">hashCode</span><span class="o">)</span>
<span class="c1">// freestyleHasherCustomerId: freestyle.cache.hashmap.Hasher[CustomerId] = freestyle.cache.hashmap.Hasher$$anon$1@29a4ff0d
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">cacheHandler</span><span class="k">:</span> <span class="kt">cacheP.CacheM.Handler</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">rawMap</span><span class="k">:</span> <span class="kt">KeyValueMap</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">CustomerId</span>, <span class="kt">Customer</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">ConcurrentHashMapWrapper</span><span class="o">[</span><span class="kt">Id</span>, <span class="kt">CustomerId</span>, <span class="kt">Customer</span><span class="o">]</span>

  <span class="k">val</span> <span class="n">cacheIdToStack</span><span class="k">:</span> <span class="kt">Id</span> <span class="kt">~&gt;</span> <span class="kt">Stack</span> <span class="o">=</span>
    <span class="k">new</span> <span class="o">(</span><span class="nc">Id</span> <span class="o">~&gt;</span> <span class="nc">Stack</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">Id</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Stack</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">a</span><span class="o">.</span><span class="n">pure</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span>
    <span class="o">}</span>

  <span class="n">cacheP</span><span class="o">.</span><span class="n">implicits</span><span class="o">.</span><span class="n">cacheHandler</span><span class="o">(</span><span class="n">rawMap</span><span class="o">,</span> <span class="n">cacheIdToStack</span><span class="o">)</span>
<span class="o">}</span>
<span class="c1">// cacheHandler: modules.cacheP.CacheM.Handler[Stack] = freestyle.cache.KeyValueProvider$implicits$CacheHandler@352bb932
</span></code></pre>
</div>

<p>We can now create a Freestyle program by specifying the type in <code class="highlighter-rouge">processOrder</code> as <code class="highlighter-rouge">App.Op</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">program</span><span class="k">:</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">App.Op</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">processOrder</span><span class="o">[</span><span class="kt">App.Op</span><span class="o">](</span><span class="nc">Order</span><span class="o">(</span><span class="mi">50</span><span class="o">,</span> <span class="s">"granny smith"</span><span class="o">,</span> <span class="n">customerId1</span><span class="o">))</span>
<span class="c1">// program: freestyle.FreeS[modules.App.Op,String] = Free(...)
</span></code></pre>
</div>

<p>With the persistence algebras, interpreters, and the <code class="highlighter-rouge">Customer</code> cache interpreter in place and with the right imports for the <code class="highlighter-rouge">reader</code> and <code class="highlighter-rouge">error</code> effect, we can execute a program resulting in <code class="highlighter-rouge">Stack[String]</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">freestyle.effects.error.implicits._</span>
<span class="c1">// import freestyle.effects.error.implicits._
</span>
<span class="k">import</span> <span class="nn">rd.implicits._</span>
<span class="c1">// import rd.implicits._
</span>
<span class="k">val</span> <span class="n">varieties</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">(</span><span class="s">"granny smith"</span><span class="o">,</span> <span class="s">"jonagold"</span><span class="o">,</span> <span class="s">"boskoop"</span><span class="o">)</span>
<span class="c1">// varieties: scala.collection.immutable.Set[String] = Set(granny smith, jonagold, boskoop)
</span>
<span class="k">val</span> <span class="n">config</span> <span class="k">=</span> <span class="nc">Config</span><span class="o">(</span><span class="n">varieties</span><span class="o">)</span>
<span class="c1">// config: Config = Config(Set(granny smith, jonagold, boskoop))
</span>
<span class="k">val</span> <span class="n">result</span><span class="k">:</span> <span class="kt">Stack</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">program</span><span class="o">.</span><span class="n">interpret</span><span class="o">[</span><span class="kt">Stack</span><span class="o">]</span>
<span class="c1">// result: Stack[String] = Kleisli(cats.data.Kleisli$$Lambda$5038/667596206@12363a2c)
</span></code></pre>
</div>

<p>We can run our <code class="highlighter-rouge">Stack</code> by supplying a <code class="highlighter-rouge">Config</code> value and running the <code class="highlighter-rouge">Task</code>.</p>

<p>By supplying a <code class="highlighter-rouge">Config</code> value we can run our <code class="highlighter-rouge">Stack</code> which results in a <code class="highlighter-rouge">Task[String]</code>.
When we want to actually execute the program, we can run the <code class="highlighter-rouge">Task</code> by using one of the methods on <code class="highlighter-rouge">Task</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">task</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">result</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">config</span><span class="o">)</span>
<span class="c1">// task: fs2.Task[String] = Task
</span>
<span class="n">task</span><span class="o">.</span><span class="n">unsafeRunSync</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="n">println</span><span class="o">,</span> <span class="n">println</span><span class="o">)</span>
<span class="c1">// Register Order(50,granny smith,00000000-0000-0000-0000-000000000000)
// Order registered for customer 00000000-0000-0000-0000-000000000000
</span></code></pre>
</div>

</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: '47deg/freestyle'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script><script src="/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>
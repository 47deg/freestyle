<html><head><title>Freestyle</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="47 Degrees" /><meta name="description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="og:image" content="/img/poster.png" /><meta name="og:title" content="Freestyle" /><meta name="og:site_name" content="Freestyle" /><meta name="og:url" content="https://frees-io.github.io/freestyle/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="Freestyle" /><meta name="twitter:image" content="https://frees-io.github.io/freestyle/img/poster.png" /><meta name="twitter:description" content="A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/dracula.css" /><link rel="stylesheet" href="/css/style.css" /><link rel="stylesheet" href="/css/palette.css" /><link rel="stylesheet" href="/css/codemirror.css" /><link rel="stylesheet" href="/css/custom.css" /><link rel="stylesheet" href="/css/theme-code.css" /><script async="async">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-18433785-14' , 'auto');
ga('send', 'pageview');
      </script></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/" class="brand"><div class="brand-wrapper"><span>Freestyle</span></div></a></li> <li><a href="/docs/" class="">Quick Start</a></li> <li><a href="/docs/core/" class="">Core Concepts</a> <ul class="sub_section"> <li><a href="/docs/core/algebras/" class="">Algebras</a></li> <li><a href="/docs/core/modules/" class="">Modules</a></li> <li><a href="/docs/core/handlers/" class="">Handlers</a></li> <li><a href="/docs/core/parallelism/" class="">Parallelism</a></li> <li><a href="/docs/core/tagless/" class="">Tagless Final</a></li></ul></li> <li><a href="/docs/effects/" class="">Effects</a> <ul class="sub_section"> <li><a href="/docs/effects/error" class="">Error</a></li> <li><a href="/docs/effects/either" class="">Either</a></li> <li><a href="/docs/effects/option" class="">Option</a></li> <li><a href="/docs/effects/reader" class="">Reader</a></li> <li><a href="/docs/effects/writer" class="">Writer</a></li> <li><a href="/docs/effects/state" class="">State</a></li> <li><a href="/docs/effects/traverse" class="">Traverse</a></li> <li><a href="/docs/effects/validation" class="">Validation</a></li> <li><a href="/docs/effects/async" class="">Async Callbacks</a></li></ul></li> <li><a href="/docs/optimizations/" class="">Optimizations</a></li> <li><a href="/docs/stack/" class="">Example Target Stack</a></li> <li><a href="/TODO.html" class="">Patterns</a> <ul class="sub_section"> <li><a href="/docs/effects/Cache/" class="">Cache</a></li> <li><a href="/TODO.html" class="">Dependency Injection</a></li> <li><a href="/docs/patterns/config" class="">Configuration</a></li> <li><a href="/docs/patterns/logging" class="">Logging</a></li></ul></li> <li><a href="/docs/integrations" class="">Integrations</a> <ul class="sub_section"> <li><a href="/docs/integrations/cats" class="">Cats</a></li> <li><a href="/docs/integrations/play" class="">Play Framework</a></li> <li><a href="/docs/integrations/monix" class="">Monix</a></li> <li><a href="/docs/integrations/fetch" class="">Fetch</a></li> <li><a href="/docs/integrations/doobie" class="">Doobie</a></li> <li><a href="/docs/integrations/slick" class="">Slick</a></li> <li><a href="/docs/integrations/akkahttp" class="">Akka HTTP</a></li> <li><a href="/docs/integrations/finch" class="">Finch</a></li> <li><a href="/docs/integrations/http4s" class="">http4s</a></li> <li><a href="/docs/integrations/hammock" class="">Hammock</a></li></ul></li> <li><a href="/docs/rpc" class="">Libraries</a> <ul class="sub_section"> <li><a href="/docs/rpc" class="">Microservices</a></li> <li><a href="/docs/effects" class="">Effects</a></li> <li><a href="/docs/cassandra" class=" active ">Cassandra</a></li> <li><a href="/docs/kafka" class="">Kafka</a></li></ul></li> <li><a href="/docs/related/" class="">Related Work</a> <ul class="sub_section"> <li><a href="/docs/related/#bibliography" class="">Bibliography</a></li> <li><a href="/docs/related/#Scala" class="">Scala Libraries</a></li></ul></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/frees-io/freestyle"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Freestyle A Cohesive &amp; Pragmatic Framework of FP centric Scala libraries');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="frees-io" data-github-repo="freestyle"><div class="content-wrapper"><section><h1 id="freestyle-cassandra">Freestyle-Cassandra</h1>

<p>[Cassandra] atop <strong>Freestyle</strong> is <strong><code class="highlighter-rouge">frees-cassandra</code></strong>.
Freestyle Cassandra is Scala Purely Functional driver for Cassandra based on the datastax Java Driver.</p>

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong>  <em>generated with <a href="https://github.com/thlorenz/doctoc">DocToc</a></em></p>

<ul>
  <li><a href="#whats-frees-cassandra">What’s frees-cassandra</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#about-freestyle-cassandra">About Freestyle Cassandra</a></li>
  <li><a href="#public-apis">Public APIs</a>
    <ul>
      <li><a href="#clusterapi">ClusterAPI</a></li>
      <li><a href="#sessionapi">SessionAPI</a></li>
      <li><a href="#statementapi">StatementAPI</a></li>
      <li><a href="#resultsetapi">ResultSetAPI</a></li>
    </ul>
  </li>
  <li><a href="#features">Features</a>
    <ul>
      <li><a href="#low-level-queries">Low level Queries</a></li>
      <li><a href="#string-interpolator">String Interpolator</a></li>
    </ul>
  </li>
  <li><a href="#references">References</a></li>
  <li><a href="#freestyle-cassandra-examples">freestyle-cassandra-examples</a>
    <ul>
      <li><a href="#lowlevelapi">LowLevelApi</a></li>
      <li><a href="#stringqueryinterpolator">StringQueryInterpolator</a></li>
    </ul>
  </li>
</ul>

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<h2 id="whats-frees-cassandra">What’s frees-cassandra</h2>

<p>[frees-cassandra] is a library to interact with cassandra built atop Free and using the Datastax 
Cassandra Driver for connecting to a Cassandra instance. It follows the [Freestyle] philosophy, 
being macro-powered.</p>

<h2 id="installation">Installation</h2>

<p>Add the following resolver and library dependency to your project’s build file.</p>

<p>For Scala <code class="highlighter-rouge">2.11.x</code> and <code class="highlighter-rouge">2.12.x</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="nc">Resolver</span><span class="o">.</span><span class="n">bintrayRepo</span><span class="o">(</span><span class="s">"tabdulradi"</span><span class="o">,</span> <span class="s">"maven"</span><span class="o">)</span>
<span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">"io.frees"</span> <span class="o">%%</span> <span class="s">"frees-cassandra"</span> <span class="o">%</span> <span class="s">"0.0.5"</span> 
</code></pre>
</div>

<h2 id="about-freestyle-cassandra">About Freestyle Cassandra</h2>

<p>Freestyle-Cassandra provides 2 different ways of use, a low level one, letting you define a query 
and bind values to it, and a String Interpolator one, which allows us to write raw queries and 
validate them at compile time against a previously defined schema.</p>

<p>In the upcoming sections, we’ll take a look at both features and how we can take advantage of them.</p>

<h2 id="public-apis">Public APIs</h2>
<p><em>Frees-Cassandra</em> provides a set of <a href="http://frees.io/docs/core/algebras/">algebras</a> to interact with 
the different pieces of a Cassandra Service. Each of those algebras represent a public API.</p>

<h3 id="clusterapi">ClusterAPI</h3>
<p>It provides methods to open/close connections to a Cassandra instance, load specific keyspaces, or 
Cassandra configuration.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">com.datastax.driver.core.</span><span class="o">{</span><span class="nc">Configuration</span><span class="o">,</span> <span class="nc">Metadata</span><span class="o">,</span> <span class="nc">Metrics</span><span class="o">,</span> <span class="nc">Session</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>

<span class="nd">@free</span>
<span class="k">trait</span> <span class="nc">ClusterAPI</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">connect</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Session</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">connectKeyspace</span><span class="o">(</span><span class="n">keyspace</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Session</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">close</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">configuration</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Configuration</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">metadata</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Metadata</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">metrics</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Metrics</span><span class="o">]</span>

<span class="o">}</span>

</code></pre>
</div>

<h3 id="sessionapi">SessionAPI</h3>
<p>Provides a way to interact with a proper query. We can both define a query as a template - containing 
placeholders for real values - or a raw query string. Bear in mind that running a raw query using the 
SessionAPI directly is unsafe and does not check query correctness at compile time.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">com.datastax.driver.core._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.query.model.SerializableValueBy</span>

<span class="nd">@free</span>
<span class="k">trait</span> <span class="nc">SessionAPI</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">init</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Session</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">close</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">prepare</span><span class="o">(</span><span class="n">query</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">PreparedStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">prepareStatement</span><span class="o">(</span><span class="n">statement</span><span class="k">:</span> <span class="kt">RegularStatement</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">PreparedStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">execute</span><span class="o">(</span><span class="n">query</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">executeWithValues</span><span class="o">(</span><span class="n">query</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">values</span><span class="k">:</span> <span class="kt">Any*</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">executeWithMap</span><span class="o">(</span><span class="n">query</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">values</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">AnyRef</span><span class="o">])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">executeStatement</span><span class="o">(</span><span class="n">statement</span><span class="k">:</span> <span class="kt">Statement</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">executeWithByteBuffer</span><span class="o">(</span>
      <span class="n">query</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
      <span class="n">values</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">SerializableValueBy</span><span class="o">[</span><span class="kt">Int</span><span class="o">]],</span>
      <span class="n">consistencyLevel</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">ConsistencyLevel</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>

<span class="o">}</span>

</code></pre>
</div>

<h3 id="statementapi">StatementAPI</h3>
<p>Provides methods to bind real query values to an already existing PreparedStatement, returning a 
BoundStatement, which can now be ran in a safe way.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">com.datastax.driver.core._</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.codecs.ByteBufferCodec</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.query.model.SerializableValueBy</span>

<span class="k">import</span> <span class="nn">java.nio.ByteBuffer</span>

<span class="nd">@free</span>
<span class="k">trait</span> <span class="nc">StatementAPI</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">bind</span><span class="o">(</span><span class="n">preparedStatement</span><span class="k">:</span> <span class="kt">PreparedStatement</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">setByteBufferByIndex</span><span class="o">(</span>
      <span class="n">boundStatement</span><span class="k">:</span> <span class="kt">BoundStatement</span><span class="o">,</span>
      <span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
      <span class="n">bytes</span><span class="k">:</span> <span class="kt">ByteBuffer</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">setByteBufferByName</span><span class="o">(</span>
      <span class="n">boundStatement</span><span class="k">:</span> <span class="kt">BoundStatement</span><span class="o">,</span>
      <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
      <span class="n">bytes</span><span class="k">:</span> <span class="kt">ByteBuffer</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">setValueByIndex</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span>
      <span class="n">boundStatement</span><span class="k">:</span> <span class="kt">BoundStatement</span><span class="o">,</span>
      <span class="n">index</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
      <span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">,</span>
      <span class="n">codec</span><span class="k">:</span> <span class="kt">ByteBufferCodec</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">setValueByName</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span>
      <span class="n">boundStatement</span><span class="k">:</span> <span class="kt">BoundStatement</span><span class="o">,</span>
      <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
      <span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">,</span>
      <span class="n">codec</span><span class="k">:</span> <span class="kt">ByteBufferCodec</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">setByteBufferListByIndex</span><span class="o">(</span>
      <span class="n">preparedStatement</span><span class="k">:</span> <span class="kt">PreparedStatement</span><span class="o">,</span>
      <span class="n">values</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">SerializableValueBy</span><span class="o">[</span><span class="kt">Int</span><span class="o">]])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">setByteBufferListByName</span><span class="o">(</span>
      <span class="n">preparedStatement</span><span class="k">:</span> <span class="kt">PreparedStatement</span><span class="o">,</span>
      <span class="n">values</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">SerializableValueBy</span><span class="o">[</span><span class="kt">String</span><span class="o">]])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">BoundStatement</span><span class="o">]</span>
<span class="o">}</span>
</code></pre>
</div>

<h3 id="resultsetapi">ResultSetAPI</h3>
<p>Provides methods to interact directly with a Cassandra ResultSet, so we can get the final Object 
representation, a list of them, or describe that that ResultSet could not have been found in the 
current Cassandra instance.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.query.mapper.FromReader</span>

<span class="nd">@free</span>
<span class="k">trait</span> <span class="nc">ResultSetAPI</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">read</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">resultSet</span><span class="k">:</span> <span class="kt">ResultSet</span><span class="o">)(</span><span class="k">implicit</span> <span class="nc">FR</span><span class="k">:</span> <span class="kt">FromReader</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">readOption</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">resultSet</span><span class="k">:</span> <span class="kt">ResultSet</span><span class="o">)(</span><span class="k">implicit</span> <span class="nc">FR</span><span class="k">:</span> <span class="kt">FromReader</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span>

  <span class="k">def</span> <span class="n">readList</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">resultSet</span><span class="k">:</span> <span class="kt">ResultSet</span><span class="o">)(</span><span class="k">implicit</span> <span class="nc">FR</span><span class="k">:</span> <span class="kt">FromReader</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span>

<span class="o">}</span>
</code></pre>
</div>

<h2 id="features">Features</h2>

<h3 id="low-level-queries">Low level Queries</h3>
<p>The Low-Level API allows us to define queries with placeholders for query constraints, which can be 
later bound to the final values, running the query in a safe mode, preventing CQL injection. 
Frees-Cassandra checks the generated query is a valid one at compile time, throwing errors in case 
any requested value, table or keyspace names does not exist at the schema definition.</p>

<p>Let’s see how we can use it:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">import</span> <span class="nn">com.datastax.driver.core._</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">freestyle.free.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.api.QueryModule</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.codecs._</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">java.util.UUID</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">def</span> <span class="n">program</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">app</span><span class="k">:</span> <span class="kt">QueryModule</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>

<span class="k">import</span> <span class="nn">app._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="n">stringTypeCodec</span><span class="k">:</span> <span class="kt">TypeCodec</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">TypeCodec</span><span class="o">.</span><span class="n">varchar</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">uuidTypeCodec</span><span class="k">:</span> <span class="kt">TypeCodec</span><span class="o">[</span><span class="kt">UUID</span><span class="o">]</span> <span class="k">=</span> <span class="nc">TypeCodec</span><span class="o">.</span><span class="n">uuid</span><span class="o">()</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">protocolVersion</span><span class="k">:</span> <span class="kt">ProtocolVersion</span> <span class="o">=</span> <span class="nc">ProtocolVersion</span><span class="o">.</span><span class="n">V4</span>

<span class="k">val</span> <span class="n">newUser</span> <span class="k">=</span> <span class="nc">User</span><span class="o">(</span><span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">(),</span> <span class="s">"Username"</span><span class="o">)</span>

<span class="k">def</span> <span class="n">bindValues</span><span class="o">(</span><span class="n">st</span><span class="k">:</span> <span class="kt">PreparedStatement</span><span class="o">)(</span>
  <span class="k">implicit</span> <span class="n">c1</span><span class="k">:</span> <span class="kt">ByteBufferCodec</span><span class="o">[</span><span class="kt">UUID</span><span class="o">],</span>
  <span class="n">c2</span><span class="k">:</span> <span class="kt">ByteBufferCodec</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">BoundStatement</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">List</span><span class="o">(</span>
    <span class="n">statementAPI</span><span class="o">.</span><span class="n">setValueByName</span><span class="o">(</span><span class="k">_:</span> <span class="kt">BoundStatement</span><span class="o">,</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">newUser</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">c1</span><span class="o">),</span>
    <span class="n">statementAPI</span><span class="o">.</span><span class="n">setValueByName</span><span class="o">(</span><span class="k">_:</span> <span class="kt">BoundStatement</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="n">newUser</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="n">c2</span><span class="o">))</span>
    <span class="o">.</span><span class="n">foldLeft</span><span class="o">[</span><span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">BoundStatement</span><span class="o">]](</span><span class="n">statementAPI</span><span class="o">.</span><span class="n">bind</span><span class="o">(</span><span class="n">st</span><span class="o">))</span> <span class="o">{</span> <span class="o">(</span><span class="n">freeS</span><span class="o">,</span> <span class="n">func</span><span class="o">)</span> <span class="k">=&gt;</span>
    <span class="n">freeS</span><span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="n">boundSt</span> <span class="k">=&gt;</span> <span class="n">func</span><span class="o">(</span><span class="n">boundSt</span><span class="o">))</span>
  <span class="o">}</span>

<span class="k">for</span> <span class="o">{</span>
  <span class="n">preparedStatement</span> <span class="k">&lt;-</span> <span class="n">sessionAPI</span><span class="o">.</span><span class="n">prepare</span><span class="o">(</span><span class="s">"INSERT INTO users (id, name) VALUES (?, ?)"</span><span class="o">)</span>
  <span class="n">boundStatement</span>    <span class="k">&lt;-</span> <span class="n">bindValues</span><span class="o">(</span><span class="n">preparedStatement</span><span class="o">)</span>
  <span class="k">_</span>                 <span class="k">&lt;-</span> <span class="n">sessionAPI</span><span class="o">.</span><span class="n">executeStatement</span><span class="o">(</span><span class="n">boundStatement</span><span class="o">)</span>
  <span class="n">user</span> <span class="k">&lt;-</span> <span class="n">sessionAPI</span><span class="o">.</span><span class="n">executeWithMap</span><span class="o">(</span>
    <span class="n">s</span><span class="s">"SELECT id, name FROM users WHERE id = ?"</span><span class="o">,</span>
    <span class="nc">Map</span><span class="o">(</span><span class="s">"id"</span> <span class="o">-&gt;</span> <span class="n">newUser</span><span class="o">.</span><span class="n">id</span><span class="o">))</span> <span class="n">map</span> <span class="o">{</span> <span class="n">rs</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="n">row</span> <span class="k">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">one</span><span class="o">()</span>
    <span class="nc">User</span><span class="o">(</span><span class="n">row</span><span class="o">.</span><span class="n">getUUID</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">row</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
  <span class="o">}</span>
  <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">sessionAPI</span><span class="o">.</span><span class="n">close</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">user</span>

<span class="o">}</span>

</code></pre>
</div>

<h3 id="string-interpolator">String Interpolator</h3>
<p>Frees-Cassandra Query Interpolator allows us to write a raw query and validate it against a 
previously defined schema.</p>

<p>To do so, we need to first define an annotated trait specifying a path to the file containing the
cassandra keyspaces &amp; tables schemas.</p>

<p>Example</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">freestyle.cassandra.query.interpolator.MacroInterpolator.SchemaFileInterpolator</span>

<span class="k">object</span> <span class="nc">Model</span> <span class="o">{</span>
    <span class="nd">@SchemaFileInterpolator</span><span class="o">(</span><span class="s">"/schema.cql"</span><span class="o">)</span>
    <span class="k">trait</span> <span class="nc">SchemaInterpolator</span>
<span class="o">}</span>
</code></pre>
</div>

<p>This annotation will be expanded via macros defining a cql string interpolator method, which
will allow us validate our queries against the real schema defined in a CQL script. 
Now we can import this SchemaInterpolator and take advantage of this macro generated utilities[1].</p>

<p>Let’s see an example. We can define an algebra to represent operations over an user, and a 
module to interact with other algebras:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">import</span> <span class="nn">com.datastax.driver.core.ResultSet</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.api._</span>
<span class="k">import</span> <span class="nn">freestyle.free.logging._</span>

<span class="nd">@free</span>
<span class="k">trait</span> <span class="nc">UserAPI</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">insert</span><span class="o">(</span><span class="n">userId</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">get</span><span class="o">(</span><span class="n">userId</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">)</span><span class="k">:</span> <span class="kt">FS</span><span class="o">[</span><span class="kt">ResultSet</span><span class="o">]</span>
<span class="o">}</span>

<span class="nd">@module</span> <span class="k">trait</span> <span class="nc">StringInterpolatorApp</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">queryModule</span><span class="k">:</span> <span class="kt">QueryModule</span>
  <span class="k">val</span> <span class="n">log</span><span class="k">:</span> <span class="kt">LoggingM</span>
  <span class="k">val</span> <span class="n">userApi</span><span class="k">:</span> <span class="kt">UserAPI</span>
<span class="o">}</span>

</code></pre>
</div>

<p>Then, we need to define a handler for that algebra:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>import java.util.UUID

import cats.MonadError
import com.datastax.driver.core.{ResultSet, Session}
import freestyle.async.AsyncContext
import freestyle.cassandra.query.interpolator._
import freestyle.cassandra.api._
import Model.SchemaInterpolator

import scala.concurrent.ExecutionContext

object implicits {

  implicit val stringTypeCodec: TypeCodec[String] = TypeCodec.varchar()
  implicit val uuidTypeCodec: TypeCodec[UUID] = TypeCodec.uuid()
  implicit val protocolVersion: ProtocolVersion = ProtocolVersion.V4

  implicit def userApiHandler[F[_]](implicit API: SessionAPI[SessionAPI.Op],
    S: Session,
    AC: AsyncContext[F],
    E: ExecutionContext,
    ME: MonadError[F, Throwable]): UserAPI.Handler[F] = new UserAPI.Handler[F] {

    import SchemaInterpolator._

    override protected[this] def insert(userId: UUID): F[ResultSet] =
      cql"INSERT INTO demodb.users (id, name) VALUES ($userId, 'Username');".attemptResultSet[F]()

    override protected[this] def get(userId: UUID): F[ResultSet] =
      cql"SELECT id, name FROM demodb.users WHERE id = $userId".attemptResultSet[F]()
  }

}
</code></pre>
</div>

<p>So, now we can compose those algebras ops easily:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>
<span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="k">import</span> <span class="nn">com.datastax.driver.core._</span>
<span class="k">import</span> <span class="nn">freestyle.free._</span>
<span class="k">import</span> <span class="nn">freestyle.free.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.api._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.implicits._</span>
<span class="k">import</span> <span class="nn">freestyle.cassandra.query.interpolator._</span>

<span class="k">object</span> <span class="nc">Example</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">java.util.UUID</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">uuid</span> <span class="k">=</span> <span class="nc">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="o">()</span>

  <span class="k">def</span> <span class="n">program</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="k">implicit</span> <span class="n">app</span><span class="k">:</span> <span class="kt">StringInterpolatorApp</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">FreeS</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  
      <span class="k">implicit</span> <span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="n">app</span><span class="o">.</span><span class="n">queryModule</span><span class="o">.</span><span class="n">sessionAPI</span>
  
      <span class="k">for</span> <span class="o">{</span>
        <span class="k">_</span>             <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">"# Executing insert query with id $uuid"</span><span class="o">)</span>
        <span class="k">_</span>             <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">userApi</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">uuid</span><span class="o">)</span>
        <span class="k">_</span>             <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="s">"# Selecting previous inserted item"</span><span class="o">)</span>
        <span class="n">userResultSet</span> <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">userApi</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">uuid</span><span class="o">)</span>
        <span class="n">user</span> <span class="k">=</span> <span class="o">{</span>
          <span class="k">val</span> <span class="n">userRow</span> <span class="k">=</span> <span class="n">userResultSet</span><span class="o">.</span><span class="n">one</span><span class="o">()</span>
          <span class="nc">User</span><span class="o">(</span><span class="n">userRow</span><span class="o">.</span><span class="n">getUUID</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">userRow</span><span class="o">.</span><span class="n">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
        <span class="o">}</span>
        <span class="k">_</span>             <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">"# Fetched item: $user"</span><span class="o">)</span>
        <span class="k">_</span>             <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="o">(</span><span class="n">s</span><span class="s">"# Closing connection"</span><span class="o">)</span>
        <span class="k">_</span>             <span class="k">&lt;-</span> <span class="n">app</span><span class="o">.</span><span class="n">queryModule</span><span class="o">.</span><span class="n">sessionAPI</span><span class="o">.</span><span class="n">close</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">user</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre>
</div>

<p>[1] Note that we need to define this trait in a different compilation unit (e.g.: a different SBT 
module) since we are using Contextual Macro Interpolator, so a new macro is defined by our macro.</p>

<h1 id="references">References</h1>

<ul>
  <li>
    <p><a href="http://frees.io/">Freestyle</a>
Frestyle Cassandra is part of the ecosystem built around Freestyle, and makes an intensive use of it.</p>
  </li>
  <li>
    <p><a href="https://github.com/schemasafe/troy">Troy</a>
We are currently using Troy for inferring the schema from a CQL script file.</p>
  </li>
  <li>
    <p><a href="https://github.com/propensive/contextual">Contextual</a>
It helps us to create string interpolators.</p>
  </li>
  <li>
    <p><a href="http://docs.datastax.com/en/developer/driver-matrix/doc/common/driverMatrix.html">Datastax Driver</a>
Interactions with Cassandra clusters are done through the Java Datastax Cassandra Driver.</p>
  </li>
</ul>

<h1 id="freestyle-cassandra-examples">freestyle-cassandra-examples</h1>

<p>All code examples are available in <a href="https://github.com/frees-io/freestyle-cassandra-example">Github</a>.</p>

<h2 id="lowlevelapi"><a href="https://github.com/frees-io/freestyle-cassandra-example/blob/master/basic/examples/src/main/scala/freestyle/cassandra/sample/LowLevelApi.scala">LowLevelApi</a></h2>
<h2 id="stringqueryinterpolator"><a href="https://github.com/frees-io/freestyle-cassandra-example/blob/master/basic/examples/src/main/scala/freestyle/cassandra/sample/StringInterpolator.scala">StringQueryInterpolator</a></h2>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/js/animations.js"></script><script src="/js/anime.min.js"></script><script>((window.gitter = {}).chat = {}).options = {
room: '47deg/freestyle'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/main.js"></script></body></html>